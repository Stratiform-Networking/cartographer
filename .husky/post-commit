#!/bin/sh
# Post-commit hook: automatically bump version based on commit type
# 
# Version bump rules:
#   - feat:  increment MINOR version (0.x.0)
#   - fix:   increment PATCH version (0.0.x)
#   - perf:  increment PATCH version (0.0.x)
#   - others: no version bump

# Skip if this is already a release commit (to prevent infinite loop)
COMMIT_MSG=$(git log -1 --pretty=%B)
if echo "$COMMIT_MSG" | grep -q "^chore(release):"; then
    echo "‚è≠Ô∏è  Skipping auto-release for release commit"
    exit 0
fi

# Only run on main branch
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$BRANCH" != "main" ]; then
    echo "‚è≠Ô∏è  Skipping auto-release on branch: $BRANCH (only runs on main)"
    exit 0
fi

# Check if AUTO_RELEASE is disabled
if [ "$SKIP_AUTO_RELEASE" = "1" ] || [ "$SKIP_AUTO_RELEASE" = "true" ]; then
    echo "‚è≠Ô∏è  Auto-release skipped (SKIP_AUTO_RELEASE is set)"
    exit 0
fi

# Extract commit type from the commit message
# Format: type(scope): subject  or  type: subject
COMMIT_TYPE=$(echo "$COMMIT_MSG" | head -1 | sed -E 's/^([a-z]+)(\(.+\))?!?:.*/\1/')

# Determine version bump based on commit type
case "$COMMIT_TYPE" in
    feat)
        RELEASE_TYPE="minor"
        echo ""
        echo "üöÄ Running automatic release (feat ‚Üí minor version bump)..."
        echo ""
        ;;
    fix)
        RELEASE_TYPE="patch"
        echo ""
        echo "üöÄ Running automatic release (fix ‚Üí patch version bump)..."
        echo ""
        ;;
    perf)
        RELEASE_TYPE="patch"
        echo ""
        echo "üöÄ Running automatic release (perf ‚Üí patch version bump)..."
        echo ""
        ;;
    *)
        echo "‚è≠Ô∏è  Skipping auto-release for commit type: $COMMIT_TYPE (no version bump)"
        exit 0
        ;;
esac

# Run standard-version with the determined release type
npm run release:$RELEASE_TYPE --silent

# Check if release was successful
if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ Release complete! Version updated and changelog generated."
    echo ""
    echo "üìù To push the release:"
    echo "   git push --follow-tags origin main"
    echo ""
    echo "üè∑Ô∏è  This will also create a GitHub Release automatically!"
    echo ""
else
    echo ""
    echo "‚ö†Ô∏è  Release failed. You can run manually with: npm run release:$RELEASE_TYPE"
    echo ""
fi
