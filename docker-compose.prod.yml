# ─────────────────────────────────────────────────────────────────────────────
# Cartographer - Production Docker Compose
# Includes nginx TLS termination for secure HTTPS access
# ─────────────────────────────────────────────────────────────────────────────
#
# Usage:
#   1. Copy .example.env to .env and configure all required values
#   2. Generate secrets: ./scripts/generate-secrets.sh >> .env
#   3. Set ENV=production in .env
#   4. Obtain TLS certificates (see below)
#   5. Run: docker compose -f docker-compose.prod.yml up -d
#
# TLS Certificate Setup:
#   Option A: Let's Encrypt (recommended for public servers)
#     - Set DOMAIN=yourdomain.com in .env
#     - Start the stack, then run:
#       docker compose -f docker-compose.prod.yml --profile certbot run --rm certbot \
#         certonly --webroot -w /var/www/certbot -d yourdomain.com
#     - Restart nginx: docker compose -f docker-compose.prod.yml restart nginx
#     - Certbot auto-renews every 12h; the nginx entrypoint reloads certs every 12h
#
#   Option B: Self-signed (testing/internal use ONLY)
#     - The nginx container generates a self-signed cert on first start
#     - Browsers will show a security warning — not suitable for production
#
# ─────────────────────────────────────────────────────────────────────────────
version: "3.8"

services:
  # ───────────────────────────────────────────────────────────────────────────
  # Nginx - TLS Termination & Reverse Proxy
  # ───────────────────────────────────────────────────────────────────────────
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: cartographer-nginx
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN:-}
    volumes:
      # Let's Encrypt certificates (symlinked to /etc/nginx/ssl/ by entrypoint)
      - letsencrypt:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Certbot - Let's Encrypt Certificate Management
  # ───────────────────────────────────────────────────────────────────────────
  certbot:
    image: certbot/certbot:latest
    container_name: cartographer-certbot
    volumes:
      - letsencrypt:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    profiles:
      - certbot

  # ───────────────────────────────────────────────────────────────────────────
  # PostgreSQL - Primary Database
  # ───────────────────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: cartographer-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-cartographer}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD must be set}
      POSTGRES_DB: ${POSTGRES_DB:-cartographer}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-cartographer}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Redis - Pub/Sub & Caching
  # ───────────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: cartographer-redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Main Application (Backend + Frontend)
  # ───────────────────────────────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cartographer-app
    volumes:
      - cartographer-data:/app/data
    environment:
      - ENV=production
      - FRONTEND_DIST=/app/frontend/dist
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-cartographer}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cartographer}
      - REDIS_URL=redis://redis:6379
      - REDIS_DB=2
      - REDIS_CACHE_ENABLED=true
      - HEALTH_SERVICE_URL=http://health:8001
      - AUTH_SERVICE_URL=http://auth:8002
      - METRICS_SERVICE_URL=http://metrics:8003
      - ASSISTANT_SERVICE_URL=http://assistant:8004
      - NOTIFICATION_SERVICE_URL=http://notifications:8005
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set}
      - CORS_ORIGINS=${CORS_ORIGINS:?CORS_ORIGINS must be set for production}
      - DISABLE_DOCS=${DISABLE_DOCS:-true}
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      health:
        condition: service_healthy
      auth:
        condition: service_healthy
      metrics:
        condition: service_healthy
      assistant:
        condition: service_healthy
      notifications:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Health Monitoring Microservice
  # ───────────────────────────────────────────────────────────────────────────
  health:
    build:
      context: ./health-service
      dockerfile: Dockerfile
    container_name: cartographer-health
    volumes:
      - health-data:/app/data
    environment:
      - ENV=production
      - CORS_ORIGINS=${CORS_ORIGINS}
      - HEALTH_DATA_DIR=/app/data
      - NOTIFICATION_SERVICE_URL=http://notifications:8005
    cap_add:
      - NET_RAW
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Auth Microservice
  # ───────────────────────────────────────────────────────────────────────────
  auth:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: cartographer-auth
    volumes:
      - auth-data:/app/data
    environment:
      - ENV=production
      - CORS_ORIGINS=${CORS_ORIGINS}
      - AUTH_DATA_DIR=/app/data
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-cartographer}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cartographer}
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set}
      - JWT_EXPIRATION_HOURS=24
      - AUTH_PROVIDER=${AUTH_PROVIDER:-local}
      - ALLOW_OPEN_REGISTRATION=${ALLOW_OPEN_REGISTRATION:-false}
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY:-}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY:-}
      - CLERK_WEBHOOK_SECRET=${CLERK_WEBHOOK_SECRET:-}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-Cartographer <noreply@cartographer.app>}
      - APPLICATION_URL=${APPLICATION_URL:-https://localhost}
      - INVITE_EXPIRATION_HOURS=${INVITE_EXPIRATION_HOURS:-72}
      - ASSISTANT_KEYS_ENCRYPTION_KEY=${ASSISTANT_KEYS_ENCRYPTION_KEY:-}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Metrics Publishing Microservice
  # ───────────────────────────────────────────────────────────────────────────
  metrics:
    build:
      context: ./metrics-service
      dockerfile: Dockerfile
    container_name: cartographer-metrics
    environment:
      - ENV=production
      - CORS_ORIGINS=${CORS_ORIGINS}
      - REDIS_URL=redis://redis:6379
      - REDIS_DB=0
      - HEALTH_SERVICE_URL=http://health:8001
      - BACKEND_SERVICE_URL=http://app:8000
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set}
      - METRICS_PUBLISH_INTERVAL=${METRICS_PUBLISH_INTERVAL:-30}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
      health:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # AI Assistant Microservice
  # ───────────────────────────────────────────────────────────────────────────
  assistant:
    build:
      context: ./assistant-service
      dockerfile: Dockerfile
    container_name: cartographer-assistant
    environment:
      - ENV=production
      - CORS_ORIGINS=${CORS_ORIGINS}
      - AUTH_SERVICE_URL=http://auth:8002
      - JWT_SECRET=${JWT_SECRET:?JWT_SECRET must be set}
      - METRICS_SERVICE_URL=http://metrics:8003
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - REDIS_URL=redis://redis:6379
      - REDIS_DB=1
      - ASSISTANT_CHAT_LIMIT_PER_DAY=${ASSISTANT_CHAT_LIMIT_PER_DAY:-99999}
      - ASSISTANT_RATE_LIMIT_EXEMPT_ROLES=${ASSISTANT_RATE_LIMIT_EXEMPT_ROLES:-}
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-cartographer}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cartographer}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      metrics:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

  # ───────────────────────────────────────────────────────────────────────────
  # Notification Microservice
  # ───────────────────────────────────────────────────────────────────────────
  notifications:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    container_name: cartographer-notifications
    volumes:
      - notification-data:/app/data
    environment:
      - ENV=production
      - TZ=${TZ:-}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - NOTIFICATION_DATA_DIR=/app/data
      - DATABASE_URL=postgresql+asyncpg://${POSTGRES_USER:-cartographer}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-cartographer}
      - CARTOGRAPHER_VERSION=${CARTOGRAPHER_VERSION:-0.1.1}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-Cartographer <notifications@cartographer.app>}
      - APPLICATION_URL=${APPLICATION_URL:-https://localhost}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID:-}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET:-}
      - DISCORD_REDIRECT_URI=${DISCORD_REDIRECT_URI:-https://localhost/api/auth/discord/callback}
      - HEALTH_SERVICE_URL=http://health:8001
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      health:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - cartographer-net

# ─────────────────────────────────────────────────────────────────────────────
# Networks
# ─────────────────────────────────────────────────────────────────────────────
networks:
  cartographer-net:
    driver: bridge

# ─────────────────────────────────────────────────────────────────────────────
# Volumes
# ─────────────────────────────────────────────────────────────────────────────
volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  cartographer-data:
    driver: local
  health-data:
    driver: local
  auth-data:
    driver: local
  notification-data:
    driver: local
  letsencrypt:
    driver: local
  certbot-www:
    driver: local
